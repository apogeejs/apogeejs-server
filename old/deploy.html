<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<script>
			
			//////////////////////////////////////////////////////////////////////////////////////////////////
			//deploy action
			
			var DEPLOY_URL = "http://localhost:8888/deploy";		
				
			function doDeploy() {
				var inputObject = readInput();
				if(!inputObject) return;
				
				var body = JSON.stringify(inputObject);
				request(DEPLOY_URL,onDownload,onFailure,"POST",body);
			}
			
			function readInput() {
				var inputObject = {};
								
				var pathFieldField = document.getElementById("pathname");
				var pathname = pathFieldField.value;
				if(pathname.charAt(0) != "/") {
					alert("Path name must start with '/'.");
					return;
				}
				inputObject.path = pathname;
				
				var inputFieldField = document.getElementById("inputTable"); 
				inputObject.inputTable = inputFieldField.value;
				
				var outputFieldField = document.getElementById("outputTable"); 
				inputObject.outputTable = outputFieldField.value;
				
				var workspaceField = document.getElementById("workspaceData"); 
				var workspaceString = workspaceField.value;
				inputObject.workspaceJson = JSON.parse(workspaceString);
				
				return inputObject;
			}
			
			function onDownload(data) {
				var outputDataField = document.getElementById("outputData");
				outputDataField.value = data;
			}
			
			function onFailure(msg) {
				alert(msg);
			}
			
			function request(url,onDownload,onFailure,httpMethod,body) {
				var xmlhttp = new XMLHttpRequest();;

				xmlhttp.onreadystatechange=function() {
					var msg;
					if (xmlhttp.readyState==4 && xmlhttp.status==200) {
						onDownload(xmlhttp.responseText);
					}
					else if(xmlhttp.readyState==4  && xmlhttp.status >= 400)  {
						msg = "Error in http request. Status: " + xmlhttp.status;
						onFailure(msg);
					}
				}

				xmlhttp.open(httpMethod,url,true);
					
				if(httpMethod == "POST") {
					xmlhttp.setRequestHeader("Content-Type","text/plain");
				}

				xmlhttp.send(body);

			}
			
			//end post action
			////////////////////////////////////////////////////////////////////////////////////

		</script>
		<style>
			.stepDiv {
				background-color: lightgray;
				outline: solid 1px gray;
				padding: 10px;
				margin: 10px;
				display: table;
			}
		</style>
	
	</head>
	<body>
		<h1>Deploy</h1>
		<div class="stepDiv">
			<p>Insert the workspace json and define the input and output fields for the endpoint.</p>
			Workspace JSON:<br>
			<textarea id="workspaceData" rows="5" cols="75">	
{"name":"Revenue Projection","fileType":"hax workspace","jsLinks":[],"cssLinks":[],"workspace":{"name":"Revenue Projection","fileType":"hax workspace","version":0.2,"data":{"name":"Revenue Projection","type":"hax.Folder","children":{"revenue_A":{"name":"revenue_A","type":"hax.JsonTable","updateData":{"argList":[],"functionBody":"var value;\nvalue = [];\nvalue[0] = settings.initialRevenue;\nfor(var i = 0; i < settings.projectionCount; i++) {\n    value[i+1] = value[i] * (1 + settings.growthRate/100);\n}\nreturn value;\n\n","supplementalCode":""}},"settings":{"name":"settings","type":"hax.JsonTable","updateData":{"data":{"initialYear":2015,"initialRevenue":1000000,"growthRate":3,"projectionCount":10}}},"revenue_B":{"name":"revenue_B","type":"hax.JsonTable","updateData":{"argList":[],"functionBody":"var value;\nvalue = [];\nvalue[0] = createEntry(settings.initialYear,settings.initialRevenue);\nfor(var i = 0; i < settings.projectionCount; i++) {\n    value[i+1] = getNextEntry(value[i]);\n}\nreturn value;\n\n","supplementalCode":"function createEntry(year,revenue) {\n    entry = {};\n    entry.year = year;\n    entry.revenue = revenue;\n    return entry;\n}\n\nfunction getNextEntry(entry) {\n    var nextEntry = {};\n    nextEntry.year = entry.year + 1;\n    nextEntry.revenue = entry.revenue * (1 + settings.growthRate/100);\n    return nextEntry;\n}"}},"revenueTable":{"name":"revenueTable","type":"hax.JsonTable","updateData":{"argList":[],"functionBody":"var value;\nvalue = [];\n\n//add heading\nvalue.push([\"Year\",\"Revenue\"]);\n\n//add yearly values\nfor(var i = 0; i < revenue_B.length; i++) {\n    value.push([revenue_B[i].year,revenue_B[i].revenue]);\n}\n\n//add total\nvalue.push([\"Total\",totalRevenue]);\nreturn value;\n\n","supplementalCode":""}},"totalRevenue":{"name":"totalRevenue","type":"hax.JsonTable","updateData":{"argList":[],"functionBody":"var value;\nvalue = 0;\n\nfor(var i = 0; i < revenue_B.length; i++) {\n    value += revenue_B[i].revenue;\n}\nreturn value;\n\n","supplementalCode":""}}}}},"components":{"revenue_A":{"key":"Revenue Projection:revenue_A","type":"haxapp.app.JsonTableComponent","coordInfo":{"x":355,"y":21,"width":519,"height":158},"windowState":0},"settings":{"key":"Revenue Projection:settings","type":"haxapp.app.JsonTableComponent","coordInfo":{"x":38,"y":25,"width":273,"height":204},"windowState":0},"revenue_B":{"key":"Revenue Projection:revenue_B","type":"haxapp.app.JsonTableComponent","coordInfo":{"x":39,"y":258,"width":447,"height":433},"windowState":0},"revenueTable":{"key":"Revenue Projection:revenueTable","type":"haxapp.app.GridTableComponent","coordInfo":{"x":947,"y":22,"width":301,"height":422},"windowState":0},"totalRevenue":{"key":"Revenue Projection:totalRevenue","type":"haxapp.app.JsonTableComponent","coordInfo":{"x":536,"y":267,"width":269,"height":79},"windowState":0}}}	
			</textarea><br>
			<br>
			Path Field:<input id="pathname" type="text" value="/revenue"><br> 
			Input Field:<input id="inputTable" type="text" value="settings"><br>
			Output Field: <input  id="outputTable" type="text" value="revenueTable"><br>
		</div>
		<button onclick="doDeploy()">Deploy Submit</button><br>
		<div class="stepDiv">
			<p>This is the body of the response.</p>
			Output Body:<br>
			<textarea id="outputData" rows="15" cols="75"></textarea><br>
		</div>
		
	</body>
</html>
